.equ PORTD, 0x0B
.equ DDRD, 0x0A

.equ WAVE_BUFFER, 0x0100

; Load a wave table into the wave buffer (lo8 bits of loc must be 0)
.macro LOAD_TABLE loc
	ldi	ZH, hi8(\loc)
	ldi     ZL, lo8(\loc)
	ldi     XH, hi8(WAVE_BUFFER)
	ldi     XL, lo8(WAVE_BUFFER)
copy_loop\@:
	lpm	r0, Z+		; Copy out of program memory
	st	X+, r0		; Copy into data memory
	cpi	ZL, 0x00	; Check if we have rolled over
	brne	copy_loop\@
.endm



.text
.org 0x0000
                jmp     RESET

.org 0x0034 ; End of Jump table
RESET:          ser     r16
                out     DDRD, r16

                clr     r16
                out     PORTD, r16

MAIN:           
		LOAD_TABLE	sine_table

;		ldi     ZH, hi8(sine_table)  ; Setup copy
;                ldi     ZL, lo8(sine_table)
;                ldi     XH, hi8(0x0100)
;                ldi     XL, lo8(0x0100)
;COPY_TABLE:     lpm      r0, Z+                  ; Loop and copy
;                st      X+, r0
;                cpi     ZL, 0x00
;                brne    COPY_TABLE

		ldi     XH, hi8(0x0100)
		ldi     XL, lo8(0x0100)
		ld      r16, X
		ldi	r17, 3
		add	r16, r17
		out     PORTD, r16

loop:           sleep
                rjmp    loop;


.org 0x0100
sine_table:
        .byte   0x7F,0x82,0x85,0x88,0x8B,0x8F,0x92,0x95,0x98,0x9B,0x9E,0xA1,0xA4,0xA7,0xAA,0xAD
        .byte   0xB0,0xB2,0xB5,0xB8,0xBB,0xBE,0xC0,0xC3,0xC6,0xC8,0xCB,0xCD,0xD0,0xD2,0xD4,0xD7
        .byte   0xD9,0xDB,0xDD,0xDF,0xE1,0xE3,0xE5,0xE7,0xE9,0xEA,0xEC,0xEE,0xEF,0xF0,0xF2,0xF3
        .byte   0xF4,0xF5,0xF7,0xF8,0xF9,0xF9,0xFA,0xFB,0xFC,0xFC,0xFD,0xFD,0xFD,0xFE,0xFE,0xFE
        .byte   0xFE,0xFE,0xFE,0xFE,0xFD,0xFD,0xFD,0xFC,0xFC,0xFB,0xFA,0xF9,0xF9,0xF8,0xF7,0xF5
        .byte   0xF4,0xF3,0xF2,0xF0,0xEF,0xEE,0xEC,0xEA,0xE9,0xE7,0xE5,0xE3,0xE1,0xDF,0xDD,0xDB
        .byte   0xD9,0xD7,0xD4,0xD2,0xD0,0xCD,0xCB,0xC8,0xC6,0xC3,0xC0,0xBE,0xBB,0xB8,0xB5,0xB2
        .byte   0xB0,0xAD,0xAA,0xA7,0xA4,0xA1,0x9E,0x9B,0x98,0x95,0x92,0x8F,0x8B,0x88,0x85,0x82
        .byte   0x7F,0x7D,0x7A,0x77,0x74,0x70,0x6D,0x6A,0x67,0x64,0x61,0x5E,0x5B,0x58,0x55,0x52
        .byte   0x4F,0x4D,0x4A,0x47,0x44,0x41,0x3F,0x3C,0x39,0x37,0x34,0x32,0x2F,0x2D,0x2B,0x28
        .byte   0x26,0x24,0x22,0x20,0x1E,0x1C,0x1A,0x18,0x16,0x15,0x13,0x11,0x10,0x0F,0x0D,0x0C
        .byte   0x0B,0x0A,0x08,0x07,0x06,0x06,0x05,0x04,0x03,0x03,0x02,0x02,0x02,0x01,0x01,0x01
        .byte   0x01,0x01,0x01,0x01,0x02,0x02,0x02,0x03,0x03,0x04,0x05,0x06,0x06,0x07,0x08,0x0A
        .byte   0x0B,0x0C,0x0D,0x0F,0x10,0x11,0x13,0x15,0x16,0x18,0x1A,0x1C,0x1E,0x20,0x22,0x24
        .byte   0x26,0x28,0x2B,0x2D,0x2F,0x32,0x34,0x37,0x39,0x3C,0x3F,0x41,0x44,0x47,0x4A,0x4D
        .byte   0x4F,0x52,0x55,0x58,0x5B,0x5E,0x61,0x64,0x67,0x6A,0x6D,0x70,0x74,0x77,0x7A,0x7D

